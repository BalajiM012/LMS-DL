<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Book Inventory - Library Management System</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
      }

      .header {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        padding: 20px 0;
        text-align: center;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        position: relative;
      }

      .welcome-title {
        font-size: 2.5rem;
        font-weight: bold;
        color: white;
        margin-bottom: 5px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      .lms-full-name {
        font-size: 1.2rem;
        color: rgba(255, 255, 255, 0.9);
        font-weight: 500;
        margin-bottom: 10px;
      }

      .user-info {
        color: white;
        font-weight: 600;
        font-size: 1.1rem;
        margin-bottom: 20px;
      }

      .nav-buttons {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 15px;
      }

      .nav-btn {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 25px;
        cursor: pointer;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .nav-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 40px 20px;
      }

      .search-section {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 40px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }

      .search-title {
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 20px;
        color: #333;
        text-align: center;
      }

      .search-form {
        display: flex;
        gap: 15px;
        justify-content: center;
        align-items: center;
        flex-wrap: wrap;
        margin-bottom: 20px;
      }

      .search-input {
        flex: 1;
        min-width: 300px;
        padding: 15px;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        font-size: 16px;
        transition: border-color 0.3s ease;
      }

      .search-input:focus {
        outline: none;
        border-color: #667eea;
      }

      .search-btn {
        padding: 15px 30px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        cursor: pointer;
        transition: transform 0.3s ease;
      }

      .search-btn:hover {
        transform: translateY(-2px);
      }

      .filter-section {
        display: flex;
        gap: 15px;
        justify-content: center;
        flex-wrap: wrap;
      }

      .filter-select {
        padding: 10px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
        background: white;
      }

      .inventory-section {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 40px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }

      .inventory-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        flex-wrap: wrap;
        gap: 20px;
      }

      .inventory-title {
        font-size: 1.8rem;
        font-weight: bold;
        color: #333;
      }

      .inventory-actions {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
      }

      .action-btn {
        padding: 12px 20px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }

      .action-btn.secondary {
        background: linear-gradient(135deg, #4facfe, #00f2fe);
      }

      .action-btn.danger {
        background: linear-gradient(135deg, #ff6b6b, #ee5a52);
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 20px;
        border-radius: 15px;
        text-align: center;
      }

      .stat-number {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .stat-label {
        font-size: 0.9rem;
        opacity: 0.9;
      }

      .inventory-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .inventory-table th,
      .inventory-table td {
        padding: 15px;
        text-align: left;
        border-bottom: 1px solid #eee;
      }

      .inventory-table th {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        font-weight: 600;
      }

      .inventory-table tr:hover {
        background: #f8f9fa;
      }

      .status-badge {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
      }

      .status-available {
        background: #d4edda;
        color: #155724;
      }

      .status-low {
        background: #fff3cd;
        color: #856404;
      }

      .status-out {
        background: #f8d7da;
        color: #721c24;
      }

      .book-actions {
        display: flex;
        gap: 8px;
      }

      .book-action-btn {
        padding: 6px 12px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.8rem;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      .edit-btn {
        background: #007bff;
        color: white;
      }

      .delete-btn {
        background: #dc3545;
        color: white;
      }

      .view-btn {
        background: #28a745;
        color: white;
      }

      .book-action-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }

      .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-top: 30px;
      }

      .pagination-btn {
        padding: 8px 16px;
        border: 2px solid #667eea;
        background: white;
        color: #667eea;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .pagination-btn:hover,
      .pagination-btn.active {
        background: #667eea;
        color: white;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      @media (max-width: 768px) {
        .welcome-title {
          font-size: 2rem;
        }

        .nav-buttons {
          flex-direction: column;
          align-items: center;
        }

        .search-form {
          flex-direction: column;
        }

        .search-input {
          min-width: 100%;
        }

        .inventory-header {
          flex-direction: column;
          align-items: stretch;
        }

        .inventory-actions {
          justify-content: center;
        }

        .inventory-table {
          font-size: 0.9rem;
        }

        .inventory-table th,
        .inventory-table td {
          padding: 10px 8px;
        }
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1 class="welcome-title">Welcome to Library Management System</h1>
      <p class="lms-full-name">Book Inventory Management</p>
      <div class="user-info">
        <span id="userName">Admin User</span>
      </div>
      <div class="nav-buttons">
        <a href="index.html" class="nav-btn">
          üè† Home
        </a>
        <button class="nav-btn" onclick="logout()">
          üö™ Logout
        </button>
      </div>
    </div>

    <div class="container">
      <!-- Search Section -->
      <div class="search-section">
        <h2 class="search-title">Search & Filter Books</h2>
        <div class="search-form">
          <input
            type="text"
            class="search-input"
            id="searchInput"
            placeholder="Search by title, author, ISBN, or category..."
          />
          <button class="search-btn" onclick="searchBooks()">üîç Search</button>
          <button class="search-btn" onclick="clearSearch()">üóëÔ∏è Clear</button>
        </div>
        <div class="filter-section">
          <select class="filter-select" id="categoryFilter">
            <option value="">All Categories</option>
            <option value="fiction">Fiction</option>
            <option value="non-fiction">Non-Fiction</option>
            <option value="science">Science</option>
            <option value="technology">Technology</option>
            <option value="history">History</option>
            <option value="biography">Biography</option>
          </select>
          <select class="filter-select" id="statusFilter">
            <option value="">All Status</option>
            <option value="available">Available</option>
            <option value="low">Low Stock</option>
            <option value="out">Out of Stock</option>
          </select>
          <select class="filter-select" id="sortBy">
            <option value="title">Sort by Title</option>
            <option value="author">Sort by Author</option>
            <option value="category">Sort by Category</option>
            <option value="quantity">Sort by Quantity</option>
            <option value="date">Sort by Date Added</option>
          </select>
        </div>
      </div>

      <!-- Inventory Section -->
      <div class="inventory-section">
        <div class="inventory-header">
          <h2 class="inventory-title">Book Inventory</h2>
          <div class="inventory-actions">
            <button class="action-btn" onclick="addNewBook()">
              ‚ûï Add New Book
            </button>
            <button class="action-btn secondary" onclick="importBooks()">
              üì• Import Books
            </button>
            <button class="action-btn secondary" onclick="exportInventory()">
              üì§ Export Inventory
            </button>
            <button class="action-btn" onclick="refreshInventory()">
              üîÑ Refresh
            </button>
          </div>
        </div>

        <!-- Statistics -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-number" id="totalBooks">0</div>
            <div class="stat-label">Total Books</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="availableBooks">0</div>
            <div class="stat-label">Available</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="borrowedBooks">0</div>
            <div class="stat-label">Borrowed</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="lowStockBooks">0</div>
            <div class="stat-label">Low Stock</div>
          </div>
        </div>

        <!-- Inventory Table -->
        <div id="inventoryTableContainer">
          <table class="inventory-table" id="inventoryTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>Title</th>
                <th>Author</th>
                <th>ISBN</th>
                <th>Category</th>
                <th>Total Qty</th>
                <th>Available</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="inventoryTableBody">
              <tr>
                <td colspan="9" class="loading">Loading inventory data...</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="pagination" id="pagination">
          <button class="pagination-btn" onclick="previousPage()">¬´ Previous</button>
          <span id="pageInfo">Page 1 of 1</span>
          <button class="pagination-btn" onclick="nextPage()">Next ¬ª</button>
        </div>
      </div>
    </div>

    <script src="js/auth.js"></script>
    <script>
      let currentPage = 1;
      let totalPages = 1;
      let booksData = [];
      let filteredBooks = [];

      // Check authentication on page load
      window.addEventListener('load', async function() {
        const hasAccess = await checkAuthAndRedirect('admin');
        if (!hasAccess) return;
        
        loadUserInfo();
        loadInventoryData();
      });

      // Load user info
      async function loadUserInfo() {
        try {
          const user = await authManager.getCurrentUser();
          if (user) {
            document.getElementById("userName").textContent = user.fullname || user.username;
          } else {
            const userFromStorage = authManager.getUserFromStorage();
            if (userFromStorage) {
              document.getElementById("userName").textContent = userFromStorage.fullname || userFromStorage.username;
            }
          }
        } catch (error) {
          console.error('Error loading user info:', error);
        }
      }

      // Load inventory data
      async function loadInventoryData() {
        try {
          const response = await fetch('/api/admin/books');
          if (response.ok) {
            const data = await response.json();
            booksData = data.books || [];
          } else {
            console.error('Failed to load books:', response.statusText);
            booksData = generateSampleData();
          }
          
          filteredBooks = [...booksData];
          await loadStats();
          renderInventoryTable();
        } catch (error) {
          console.error('Error loading inventory:', error);
          booksData = generateSampleData();
          filteredBooks = [...booksData];
          updateStats();
          renderInventoryTable();
        }
      }

      // Load statistics from API
      async function loadStats() {
        try {
          const response = await fetch('/api/admin/books/stats');
          if (response.ok) {
            const stats = await response.json();
            document.getElementById('totalBooks').textContent = stats.total_books;
            document.getElementById('availableBooks').textContent = stats.total_available;
            document.getElementById('borrowedBooks').textContent = stats.total_borrowed;
            document.getElementById('lowStockBooks').textContent = stats.low_stock_books;
          } else {
            updateStats(); // Fallback to client-side calculation
          }
        } catch (error) {
          console.error('Error loading stats:', error);
          updateStats(); // Fallback to client-side calculation
        }
      }

      // Generate sample data for demonstration
      function generateSampleData() {
        const categories = ['Fiction', 'Non-Fiction', 'Science', 'Technology', 'History', 'Biography'];
        const sampleBooks = [];
        
        for (let i = 1; i <= 50; i++) {
          const totalQty = Math.floor(Math.random() * 20) + 1;
          const borrowed = Math.floor(Math.random() * totalQty);
          const available = totalQty - borrowed;
          
          sampleBooks.push({
            id: i,
            title: `Sample Book Title ${i}`,
            author: `Author ${i}`,
            isbn: `978-${Math.floor(Math.random() * 1000000000)}`,
            category: categories[Math.floor(Math.random() * categories.length)],
            total_quantity: totalQty,
            available_quantity: available,
            status: available === 0 ? 'out' : available <= 2 ? 'low' : 'available'
          });
        }
        
        return sampleBooks;
      }

      // Update statistics
      function updateStats() {
        const total = filteredBooks.length;
        const available = filteredBooks.reduce((sum, book) => sum + book.available_quantity, 0);
        const borrowed = filteredBooks.reduce((sum, book) => sum + (book.total_quantity - book.available_quantity), 0);
        const lowStock = filteredBooks.filter(book => book.status === 'low' || book.status === 'out').length;

        document.getElementById('totalBooks').textContent = total;
        document.getElementById('availableBooks').textContent = available;
        document.getElementById('borrowedBooks').textContent = borrowed;
        document.getElementById('lowStockBooks').textContent = lowStock;
      }

      // Render inventory table
      function renderInventoryTable() {
        const tbody = document.getElementById('inventoryTableBody');
        const itemsPerPage = 10;
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const pageBooks = filteredBooks.slice(startIndex, endIndex);

        if (pageBooks.length === 0) {
          tbody.innerHTML = '<tr><td colspan="9" class="loading">No books found</td></tr>';
          return;
        }

        tbody.innerHTML = pageBooks.map(book => `
          <tr>
            <td>${book.id}</td>
            <td>${book.title}</td>
            <td>${book.author}</td>
            <td>${book.isbn}</td>
            <td>${book.category}</td>
            <td>${book.total_quantity}</td>
            <td>${book.available_quantity}</td>
            <td>
              <span class="status-badge status-${book.status}">
                ${book.status === 'available' ? 'Available' : 
                  book.status === 'low' ? 'Low Stock' : 'Out of Stock'}
              </span>
            </td>
            <td>
              <div class="book-actions">
                <button class="book-action-btn view-btn" onclick="viewBook(${book.id})">View</button>
                <button class="book-action-btn edit-btn" onclick="editBook(${book.id})">Edit</button>
                <button class="book-action-btn delete-btn" onclick="deleteBook(${book.id})">Delete</button>
              </div>
            </td>
          </tr>
        `).join('');

        updatePagination();
      }

      // Update pagination
      function updatePagination() {
        const itemsPerPage = 10;
        totalPages = Math.ceil(filteredBooks.length / itemsPerPage);
        document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
      }

      // Search functionality
      function searchBooks() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const categoryFilter = document.getElementById('categoryFilter').value;
        const statusFilter = document.getElementById('statusFilter').value;

        filteredBooks = booksData.filter(book => {
          const matchesSearch = !searchTerm || 
            book.title.toLowerCase().includes(searchTerm) ||
            book.author.toLowerCase().includes(searchTerm) ||
            book.isbn.toLowerCase().includes(searchTerm) ||
            book.category.toLowerCase().includes(searchTerm);

          const matchesCategory = !categoryFilter || 
            book.category.toLowerCase() === categoryFilter.toLowerCase();

          const matchesStatus = !statusFilter || book.status === statusFilter;

          return matchesSearch && matchesCategory && matchesStatus;
        });

        // Apply sorting
        const sortBy = document.getElementById('sortBy').value;
        filteredBooks.sort((a, b) => {
          switch (sortBy) {
            case 'author':
              return a.author.localeCompare(b.author);
            case 'category':
              return a.category.localeCompare(b.category);
            case 'quantity':
              return b.total_quantity - a.total_quantity;
            case 'date':
              return b.id - a.id; // Assuming higher ID means newer
            default:
              return a.title.localeCompare(b.title);
          }
        });

        currentPage = 1;
        updateStats();
        renderInventoryTable();
      }

      function clearSearch() {
        document.getElementById('searchInput').value = '';
        document.getElementById('categoryFilter').value = '';
        document.getElementById('statusFilter').value = '';
        document.getElementById('sortBy').value = 'title';
        filteredBooks = [...booksData];
        currentPage = 1;
        updateStats();
        renderInventoryTable();
      }

      // Pagination functions
      function previousPage() {
        if (currentPage > 1) {
          currentPage--;
          renderInventoryTable();
        }
      }

      function nextPage() {
        if (currentPage < totalPages) {
          currentPage++;
          renderInventoryTable();
        }
      }

      // Book management functions
      function addNewBook() {
        window.location.href = 'book-management-enhanced.html?action=add';
      }

      function viewBook(id) {
        window.location.href = `book-management-enhanced.html?action=view&id=${id}`;
      }

      function editBook(id) {
        window.location.href = `book-management-enhanced.html?action=edit&id=${id}`;
      }

      function deleteBook(id) {
        if (confirm('Are you sure you want to delete this book?')) {
          // Implement delete functionality
          alert(`Delete book with ID: ${id}`);
          // Refresh data after deletion
          loadInventoryData();
        }
      }

      function importBooks() {
        alert('Import books functionality - to be implemented');
      }

      function exportInventory() {
        alert('Export inventory functionality - to be implemented');
      }

      function refreshInventory() {
        loadInventoryData();
      }

      // Logout function
      async function logout() {
        const result = await authManager.logout();
        if (result.success) {
          window.location.href = "index.html";
        } else {
          alert('Logout failed: ' + result.error);
          window.location.href = "index.html";
        }
      }

      // Event listeners for filters
      document.getElementById('categoryFilter').addEventListener('change', searchBooks);
      document.getElementById('statusFilter').addEventListener('change', searchBooks);
      document.getElementById('sortBy').addEventListener('change', searchBooks);

      // Handle search on Enter key
      document.getElementById('searchInput').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
          searchBooks();
        }
      });
    </script>
  </body>
</html>
